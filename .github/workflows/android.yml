name: Android CI

on:
  push:
    branches: [ "release" ]

env:
  MAVEN_OPTS: >-
    -Dmaven.wagon.httpconnectionManager.ttlSeconds=120

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: set up JDK 18
      uses: actions/setup-java@v3
      with:
        java-version: '18'
        distribution: 'temurin'
        // cache: gradle

    - uses: gradle/gradle-build-action@v2
      with:
       gradle-version: 7.5
       
    - name: Execute Gradle build
      run: ./gradlew assembleRelease --stacktrace
      
 #   - name: Cache Gradle packages
 #     uses: actions/cache@v1
 #     with:
 #         path: ~/.gradle/caches
 #         key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle') }}
 #         restore-keys: ${{ runner.os }}-gradle

    - name: Retrieve Version
      run: |
        echo "::set-output name=VERSION_NAME::$(${{github.workspace}}/gradlew -q printVersionName)"
      id: android_version

    - name: Get version
      run: |
        echo "version_name=${{steps.android_version.outputs.VERSION_NAME}}" >> $GITHUB_ENV

    - name: Release
      uses: softprops/action-gh-release@v1
      # if: startsWith(github.ref, 'refs/tags/')
      with:
        files: ${{ github.workspace }}/app/build/outputs/apk/release/app-release.apk
        tag_name: v${{env.version_name}}
        token: ${{ secrets.TOKEN }}
